<div class="container-fluid">
	<div class="col-md-6">
		<div class="well">
			<%= form_for :item, url: admin_item_path(@item), html: { method: :patch, class: "form-horizontal", id: 'item_form' } do |f| %>

				<% if @item.errors.any? %>
					<div id="error_explanation">
						<h2>
			        <%= pluralize(@article.errors.count, "error") %> prohibited
			        this article from being saved:
			      </h2>
			      <ul>
			        <% @article.errors.full_messages.each do |msg| %>
			          <li><%= msg %></li>
			        <% end %>
			      </ul>
					</div>
				<% end %>

				<div class="form-group">
					<%= f.label :box, { class: 'col-sm-2 control-label' } %>
					<div class="col-sm-9">
						<p class="form-control-static"><%= @item.box.display_name %></p>
					</div>
				</div>

				<div class="form-group">
					<%= f.label :path, { class: 'col-sm-2 control-label' } %>
					<div class="col-sm-9">
						<p class="form-control-static"><%= @item.path %></p>
					</div>
				</div>

				<div class="form-group">
					<%= f.label :name, 'Name<br>(ko, en, cn, ja)'.html_safe, { class: 'col-sm-2 control-label' } %>
					<div class="col-sm-9">
						<%= f.fields_for :name do |ff| %>
							<% ['ko', 'en', 'cn', 'ja'].each do |locale| %>
								<div class="col-sm-3 nested-col">
									<%= ff.text_field "#{locale}", { class: 'form-control nested_input', value: @item.item_names.where(:locale => locale).first.name } %>
								</div>
							<% end %>
						<% end %>
					</div>
				</div>

				<div class="form-group">
					<%= f.label :original_price, { class: 'col-sm-2 control-label' } %>
					<div class="col-sm-9">
						<%= f.text_field :original_price, { class: 'form-control' } %>
					</div>
				</div>

				<div class="form-group">
					<%= f.label :sale_price, { class: 'col-sm-2 control-label' } %>
					<div class="col-sm-9">
						<%= f.text_field :sale_price, { class: 'form-control' } %>
					</div>
				</div>

				<div class="form-group">
					<%= f.label :weight, { class: 'col-sm-2 control-label' } %>
					<div class="col-sm-9">
						<%= f.text_field :weight, { class: 'form-control' } %>
					</div>
				</div>

				<div class="form-group">
					<%= f.label :buy_limit, { class: 'col-sm-2 control-label' } %>
					<div class="col-sm-9">
						<%= f.text_field :buy_limit, { class: 'form-control' } %>
					</div>
				</div>

				<div class="form-group">
					<div class="col-sm-offset-2 col-sm-9">
						<div class="checkbox">
							<%= f.label :limited do %>
								<%= f.check_box :limited %>한정 상품
							<% end %>
						</div>
					</div>
				</div>

				<div class="form-group">
					<input type="hidden" id="item_original_quantity" value="<%= @item.quantity.nil? ? '-1' : @item.quantity %>">
					<%= f.label :quantity, { class: 'col-sm-2 control-label' } %>
					<div class="col-sm-9">
						<%= f.text_field :quantity, { class: 'form-control' } %>
					</div>
				</div>

				<div class="form-group">
					<div class="col-sm-offset-2 col-sm-9">
						<div class="checkbox">
							<%= f.label :periodic do %>
								<%= f.check_box :periodic %>정기 구매
							<% end %>
						</div>
					</div>
				</div>

				<div class="form-group">
					<div class="col-sm-offset-2 col-sm-9">
						<div class="checkbox">
							<%= f.label :opened do %>
								<%= f.check_box :opened %>판매중
							<% end %>
						</div>
					</div>
				</div>		

				<div class="form-group">
					<div class="col-sm-offset-2 col-sm-9">
						<%= f.submit '수정', { type: 'reset', class: 'btn btn-primary', id: 'item_form_submit' } %>
						<%= f.submit '초기화', { type: 'reset', class: 'btn btn-default', id: 'item_form_reset' } %>
					</div>			
				</div>
			<% end %>
		</div>
	</div>
	<div class="col-md-6">
		<div class="well">
			<div>
				<h3>옵션 수정</h3>
			</div>
			<div>
				<%= form_for :options, url: admin_items_update_options_path(@item.id), html: { method: :patch, id: 'option_form', remote: true } do |f| %>

					<table class="table table-bordered detail_table">
						<thead>
							<tr class="active">
								<th>name</th>
								<th>type</th>
								<th>max_len</th>
								<th>eng_only</th>
								<th>name</th>
								<th>quan</th>
								<th>lim</th>
								<th>price_chn</th>
							</tr>
						</thead>
						<tbody>
							<% @item.options.each_with_index do |o, i| %>
								<%= f.fields_for "option_#{i}" do |ff| %>
									<%= ff.hidden_field :id, { value: o.id } %>
									<% if (cnt = o.option_items.count) == 0 %>
										<tr>
											<td><%= ff.text_field :title, { value: o.title } %></td>
											<td><p class="form-control-static"><%= Option::TYPE[o.option_type] %></p></td>
											<td>
												<% if o.option_type == OPTION_TYPE_STRING %>
													<%= ff.text_field :max_length, { value: o.max_length } %>
												<% else %>
													<p class="form-control-static"></p>
												<% end %>
											</td>
											<td>
												<% if o.option_type == OPTION_TYPE_STRING %>
													<div class="">
														<% opt = o.english_only ? { checked: 'checked' }  : {} %>
														<%= ff.check_box :english_only, opt %>
													</div>
												<% else %>
													<p class="form-control-static"></p>
												<% end %>
											</td>
											<td colspan="4"></td>
										</tr>
									<% else %>
										<% o.option_items.each_with_index do |oi, idx| %>
											<%= ff.fields_for "option_item_#{idx}" do |fff| %>
												<tr>
													<%= fff.hidden_field :id, { value: oi.id } %>
													<% if idx == 0 %>
														<td rowspan="<%=cnt%>"><%= ff.text_field :title, { value: o.title } %></td>
														<td rowspan="<%=cnt%>"><p class="form-control-static"><%= Option::TYPE[o.option_type] %></p></td>
														<td rowspan="<%=cnt%>">
															<% if o.option_type == OPTION_TYPE_STRING %>
																<%= ff.text_field :max_length, { value: o.max_length } %>
															<% else %>
																<p class="form-control-static"></p>
															<% end %>
														</td>
														<td rowspan="<%=cnt%>">
															<% if o.option_type == OPTION_TYPE_STRING %>
																<div class="">
																	<% opt = o.english_only ? { checked: 'checked' }  : {} %>
																	<%= ff.check_box :english_only, opt %>
																</div>
															<% else %>
																<p class="form-control-static"></p>
															<% end %>
														</td>
														<td><%= fff.text_field :name, { value: oi.name } %></td>
														<td><%= fff.text_field :quantity, { value: oi.quantity } %></td>
														<td>
															<div class="">
																<% opt = oi.limited ? { checked: 'checked' }  : {} %>
																<%= fff.check_box :limited, opt %>
															</div>
														</td>
														<td><%= oi.price_change %></td>
													<% else %>
														<td><%= fff.text_field :name, { value: oi.name } %></td>
														<td><%= fff.text_field :quantity, { value: oi.quantity } %></td>
														<td>
															<div class="">
																<% opt = oi.limited ? { checked: 'checked' }  : {} %>
																<%= fff.check_box :limited, opt %>
															</div>
														</td>
														<td><%= oi.price_change %></td>
													<% end %>
												</tr>
											<% end %>
										<% end %>
									<% end %>
								<% end %>
							<% end %>
						</tbody>
					</table>
					<div class="">
						<%= f.submit '수정', { type: 'reset', class: 'btn btn-primary', id: 'option_form_submit' } %>
						<%= f.submit '초기화', { type: 'reset', class: 'btn btn-default', id: 'option_form_reset' } %>
					</div>
				<% end #form %>
			</div>
		</div>
	</div>
</div>


<script>
	var limit_check = function(){
		var checkbox = $("input[name='item[limited]']");
		var target = $("#item_quantity");
		if ( checkbox.is(':checked') ) {
			target.val( $("#item_original_quantity").val() );
			target.removeAttr('disabled');
		}
		else {
			target.val('-1');
			target.attr('disabled', 'disabled');
		}
	};

	$(document).ready(function(){
		limit_check();
		$('#item_limited').change(limit_check);
		$("#item_form_reset").click(function(e){
			e.preventDefault();
			$('#item_form')[0].reset();
			limit_check();
		});
		$('#item_form_submit').click(function(e){
			e.preventDefault();
			$('#item_form').submit();
		});
		$('#option_form_submit').click(function(e){
			e.preventDefault();
			$('#option_form').submit();
		});
		$('#option_form_reset').click(function(e){
			e.preventDefault();
			$('#option_form')[0].reset();
		});
		$('#option_form').on("ajax:success", function(e, data, status, xhr){
			$(".flashes").html("<div class='flash flash_notice'>" + xhr.responseText + "</div>");
		}).on("ajax:error", function(e, xhr, status, error){
			$(".flashes").html("<div class='flash flash_error'>" + xhr.responseText + "</div>");
		});
	});
</script>