<div class="container" >
  <div class="row box_wrap">
    <%= render :partial => '/mypage/left_list' %>
    <div class="col-md-10">
      <hr>
      <table class="table table-bordered">
        <thead>
          <tr class="active align_middle">
            <th class="text-center">
              <%=t('order_state') %><br>
              <%= '(' + t('order_number') + ')'%>
            </th>
            <th class="text-center"><%=t('item_display_name')%></th>
            <th class="text-center"><%=t('carry_price')%></th>
            <th class="text-center"><%=t('carry_quantity')%></th>
            <th class="text-center"><%=t('shipping')%></th>
            <th class="text-center"><%=t('carry_total_price')%></th>
            <th class="text-center"><%=t('order_status')%></th>
            <th class="text-center"><%=t('new_request_header')%></th>
          </tr>
        </thead>
        <tbody>
          <% if (current_user.purchases.size <= 0) or (current_user.purchases.first.orders.valid.count <= 0) %>
            <tr class="list_cell">
              <td class="text-center" colspan="8">
                <br><%=t('empty_order')%><br>
                <br><a href="/"><%= t('more_shopping') %></a><br>
              </td>
            </tr>
          <% else %>

          <% current_user.purchases.each do |purchase| %>
            <%# purchase.orders.valid.each_with_index do |order, index|%>
            <% OrderGroup.grouping(purchase.orders.valid).each_with_index do |order_group, index| %>
              <% cnt = order_group.orders.length %>
              <% order_group.orders.each_with_index do |order, sub_idx| %>
                <tr class="list_cell">

                  <% if index == 0 and sub_idx == 0 %>
                    <td rowspan="<%=purchase.orders.valid.count+1%>" class="text-center">
                      <% if purchase.status == Purchase::STATUS_ORDERING %>
                        <a href="/pay/order"><%= t("#{Purchase::STATUSES[purchase.status]}") %></a>
                      <% else %>
                        <%= t("#{Purchase::STATUSES[purchase.status]}") %>
                        <% if [Purchase::STATUS_PAID, Purchase::STATUS_CANCEL].include? purchase.status %>
                          <br>
                          (<%= purchase.reference_number %>)
                        <% end %>
                      <% end %>
                    </td>
                  <% end %>

                  <% periodic = if order.item.periodic then "(" + t("periodoc_#{order.order_periodic}month") + ")" else nil end %>
                  <% options = Array.new(1){periodic} %>
                  <% order.order_option_items.each do |x| %>
                    <% options << x.option_item.name if  x.option.option_type == 1 %>
                    <% options << x.option_text if  x.option.option_type == 2 %>
                  <% end %>
                  <% options.compact! %>

                  <td><a href="/item/<%=order.item.path%>"><%= order.item.display_name %></a><br><span><%= options.join(", ") %></span></td>
                  <td class="text-center"><%= Order.change_currency_pretty(order.total_price) %></td>
                  <td class="text-center"><%= number_with_delimiter(order.quantity) %></td>
                  <% if sub_idx == 0 %>
                    <td style="max-width:150px" rowspan="<%=cnt%>" class="text-center">
                      <span style="white-space:normal" class="badge badge-default"><%= t(order.shipping.name) %></span><br>
                      <%= Order.change_currency(order_group.get_delivery_fee) %>
                    </td>
                    <td rowspan="<%=cnt%>" class="text-center">
                      <%= Order.change_currency_pretty(order_group.final_order_price) %>
                    </td>
                  <% end %>
                  <td class="text-center"><%= t(Order::STATUSES[order.status]) %></td>
                  <td class="text-center">
                    <% if purchase.status == Purchase::STATUS_PAID %>
                    <%# only when status is paid %>
                      <% if order.has_request? %>
                        <% if order.has_return? %>
                          <%= t(Return::STATUSES[order.return.status]) %>
                        <% elsif order.has_cancel? %>
                          <%= t(Cancel::STATUSES[order.cancel.status]) %>
                        <% else %>
                          <%= t(Change::STATUSES[order.change.status]) %>
                        <% end %>
                      <% else %>
                        <%= link_to t('new_request'), mypage_new_request_path(:order_id => order.id) %>
                      <% end %>
                    <% end %>
                  </td>

                </tr>
              <% end %>
            <% end %>

            <% address_full = Array.new %>
            <% address_full << [t('country_comment'), current_user.country].join(" : ") %>
            <% address_full << [t('postcode_comment'), purchase.postcode].join(" : ") %>
            <% if ["US", "CA"].include? current_user.country %>
              <% address_full << [t('state_comment'), purchase.state].join(" : ") %>
            <% end %>
            <% if !["KR"].include? current_user.country %>
              <% address_full << [t('city_comment'), purchase.city].join(" : ") %>
            <% end %>
            <% address_full << [t('address_comment'), purchase.address].join(" : ") %>
            <% address_full << [t('phone_comment'), purchase.phonenumber].join(" : ") %>
            <% address_full << [t('user_detail_recipient'), purchase.recipient].join(" : ") %>

            <tr class="list_cell">
              <td colspan="7">
                [<%= t('mypage_carry')%>]&nbsp;<%= address_full.join(", ") %>
              <% if purchase.status == Purchase::STATUS_PENDING %>
                <br>[<%= t('bank_transfer_info') %>] <%=purchase.pay_type%>
              <% end %>
              </td>
            </tr>
          <% end %>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
</div>